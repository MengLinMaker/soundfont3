{"version":3,"file":"generators.js","sources":["../../../../src/chunks/parsers/generators.ts"],"sourcesContent":["import { SF2Chunk } from '../../chunk'\nimport { ParseError } from '../../riff'\nimport { Generator, GeneratorType } from '../../types'\nimport { SF_GENERATOR_SIZE } from '../../constants'\n\n/**\n * An array of GeneratorTypes that cannot be specified for presets. If one of these generator types\n * is found, the generator should be ignored.\n */\nconst PRESET_TYPES_BLACKLIST: number[] = [\n  GeneratorType.StartAddrsOffset,\n  GeneratorType.EndAddrsOffset,\n  GeneratorType.StartLoopAddrsOffset,\n  GeneratorType.EndLoopAddrsOffset,\n  GeneratorType.StartAddrsCoarseOffset,\n  GeneratorType.EndAddrsCoarseOffset,\n  GeneratorType.StartLoopAddrsCoarseOffset,\n  GeneratorType.KeyNum,\n  GeneratorType.Velocity,\n  GeneratorType.EndLoopAddrsCoarseOffset,\n  GeneratorType.SampleModes,\n  GeneratorType.ExclusiveClass,\n  GeneratorType.OverridingRootKey\n]\n\n/**\n * An array of GeneratorTypes that cannot be specified for instruments. If one of these generator\n * types is found, the generator should be ignored.\n */\nconst INSTRUMENT_TYPES_BLACKLIST: number[] = [\n  GeneratorType.Unused1,\n  GeneratorType.Unused2,\n  GeneratorType.Unused3,\n  GeneratorType.Unused4,\n  GeneratorType.Reserved1,\n  GeneratorType.Reserved2,\n  GeneratorType.Reserved3\n]\n\n/**\n * These GeneratorTypes specify a range of key numbers or velocity.\n */\nconst RANGE_TYPES: number[] = [GeneratorType.KeyRange, GeneratorType.VelRange]\n\n/**\n * Get all generators for either an preset generator chunk or a instrument generator chunk.\n *\n * TODO: Check if generator chunk is valid, by following the rules defined in the spec. See for\n * example: https://github.com/FluidSynth/fluidsynth/blob/v2.0.3/src/sfloader/fluid_sffile.c\n *\n * @param {SF2Chunk} chunk - The input chunk\n * @param {string} type - The type, can be 'pgen' or 'igen'\n */\nexport const getGenerators = (chunk: SF2Chunk, type: 'pgen' | 'igen'): Generator[] => {\n  if (chunk.id !== type) {\n    throw new ParseError('Unexpected chunk ID', `'${type}'`, `'${chunk.id}'`)\n  }\n\n  if (chunk.length % SF_GENERATOR_SIZE) {\n    throw new ParseError(`Invalid size for the '${type}' sub-chunk`)\n  }\n\n  return chunk.iterate<Generator>((iterator) => {\n    const id = iterator.getInt16()\n\n    // Ignore invalid IDs\n    if (!GeneratorType[id]) {\n      return null\n    }\n\n    if (type === 'pgen' && PRESET_TYPES_BLACKLIST.includes(id)) {\n      return null\n    }\n\n    if (type === 'igen' && INSTRUMENT_TYPES_BLACKLIST.includes(id)) {\n      return null\n    }\n\n    if (RANGE_TYPES.includes(id)) {\n      return {\n        id,\n        range: {\n          lo: iterator.getByte(),\n          hi: iterator.getByte()\n        }\n      }\n    }\n\n    return {\n      id,\n      value: iterator.getInt16BE()\n    }\n  })\n}\n"],"names":["PRESET_TYPES_BLACKLIST","GeneratorType","StartAddrsOffset","EndAddrsOffset","StartLoopAddrsOffset","EndLoopAddrsOffset","StartAddrsCoarseOffset","EndAddrsCoarseOffset","StartLoopAddrsCoarseOffset","KeyNum","Velocity","EndLoopAddrsCoarseOffset","SampleModes","ExclusiveClass","OverridingRootKey","INSTRUMENT_TYPES_BLACKLIST","Unused1","Unused2","Unused3","Unused4","Reserved1","Reserved2","Reserved3","RANGE_TYPES","KeyRange","VelRange","chunk","type","id","ParseError","length","SF_GENERATOR_SIZE","iterate","iterator","getInt16","includes","range","lo","getByte","hi","value","getInt16BE"],"mappings":"qKASA,MAAMA,EAAmC,CACvCC,EAAAA,cAAcC,iBACdD,EAAAA,cAAcE,eACdF,EAAAA,cAAcG,qBACdH,EAAAA,cAAcI,mBACdJ,EAAAA,cAAcK,uBACdL,EAAAA,cAAcM,qBACdN,EAAAA,cAAcO,2BACdP,EAAAA,cAAcQ,OACdR,EAAAA,cAAcS,SACdT,EAAAA,cAAcU,yBACdV,EAAAA,cAAcW,YACdX,EAAAA,cAAcY,eACdZ,EAAAA,cAAca,mBAOVC,EAAuC,CAC3Cd,EAAAA,cAAce,QACdf,EAAAA,cAAcgB,QACdhB,EAAAA,cAAciB,QACdjB,EAAAA,cAAckB,QACdlB,EAAAA,cAAcmB,UACdnB,EAAAA,cAAcoB,UACdpB,EAAAA,cAAcqB,WAMVC,EAAwB,CAACtB,EAAcA,cAAAuB,SAAUvB,gBAAcwB,gCAWxC,CAACC,EAAiBC,KACzC,GAAAD,EAAME,KAAOD,EACT,MAAA,IAAIE,EAAAA,WAAW,sBAAuB,IAAIF,KAAS,IAAID,EAAME,OAGjE,GAAAF,EAAMI,OAASC,oBACjB,MAAM,IAAIF,EAAAA,WAAW,yBAAyBF,gBAGzC,OAAAD,EAAMM,SAAoBC,IACzB,MAAAL,EAAKK,EAASC,WAGhB,OAACjC,EAAAA,cAAc2B,GAIN,SAATD,GAAmB3B,EAAuBmC,SAASP,IAI1C,SAATD,GAAmBZ,EAA2BoB,SAASP,GAHlD,KAOLL,EAAYY,SAASP,GAChB,CACLA,KACAQ,MAAO,CACLC,GAAIJ,EAASK,UACbC,GAAIN,EAASK,YAKZ,CACLV,KACAY,MAAOP,EAASQ,cAvBT,IAwBT,GACD"}